program monte_carlo_dice  							! Начало программы для моделирования подбрасывания кубика методом Монте-Карло
    use omp_lib  								! Подключение библиотеки OpenMP для многопоточного программирования
    implicit none  								! Отключение неявного объявления переменных, требуя явного указания типа для каждой переменной

    integer, parameter :: N = 6  						! Кубик с 6 гранями (числа от 1 до 6)
    integer, parameter :: num_trials = 1e6  					! Количество подбрасываний кубика (один миллион)
    integer :: i, rand_val, chunk, num_threads  				! Переменные для итерации и случайного значения кубика
    integer :: counts(N)  							! Массив для хранения количества выпадений каждого числа от 1 до 6
    real :: rnum  								! Переменная для генерации случайного числа с плавающей запятой (0 <= rnum < 1)
    integer :: seed_size  							! Размер массива для генератора случайных чисел
    integer, dimension(:), allocatable :: seed  				! Массив для инициализации генератора случайных чисел

    ! Узнаем размер массива для seed 
    call random_seed(size=seed_size)  						! Вызов функции для получения размера массива seed
    allocate(seed(seed_size))  							! Динамическое выделение памяти для массива seed

    ! Инициализация генератора случайных чисел
    seed = [(i, i = 1, seed_size)]  						! Заполняем массив seed значениями от 1 до seed_size
    call random_seed(put=seed)  						! Устанавливаем начальное состояние (seed) для генератора случайных чисел

    ! Инициализируем массив для подсчета выпадений каждого числа кубика
    counts = 0  								! Устанавливаем все элементы массива counts в 0

    ! Параллельная секция с использованием OpenMP для многопоточного выполнения
    !$omp parallel private(i, rand_val, rnum) shared(counts)  			! Создание параллельных потоков, переменные i, rand_val, rnum — локальные для каждого потока, counts — общий массив
    !$omp do  									! Означает, что каждый поток будет выполнять часть итераций цикла
    do i = 1, num_trials  							! Цикл для выполнения одного миллиона бросков кубика
        ! Генерация случайного числа от 0 до 1
        call random_number(rnum)  						! Генерация случайного числа rnum в диапазоне [0, 1)
        rand_val = int(rnum * N) + 1  						! Преобразуем rnum в целое число в диапазоне [1, N], моделируя бросок кубика

        ! Критическая секция для защиты доступа к общему ресурсу counts
        !$omp atomic  								! Означает, что эта операция будет выполняться атомарно (безопасно в многопоточном режиме)
        counts(rand_val) = counts(rand_val) + 1  				! Увеличиваем счетчик выпадений соответствующего числа
    end do
    !$omp end do  								! Завершение параллельного цикла
    !$omp end parallel  							! Конец параллельной секции OpenMP

    ! Вывод результатов
    print *, "Результаты подбрасывания кубика:"  				! Заголовок для вывода результатов
    do i = 1, N  								! Цикл для вывода количества выпадений каждого числа от 1 до 6
        print *, "Число ", i, ": ", counts(i)  					! Печатаем результат: сколько раз выпало число i
    end do

    deallocate(seed)  								! Освобождаем память, выделенную под массив seed

end program monte_carlo_dice  							! Конец программы
